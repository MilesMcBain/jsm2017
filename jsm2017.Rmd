---
title: 'Expanding ggplot2 for better visual exploration of missing data'
author: "Nicholas Tierney, Dianne Cook, Monash University"
date: "15/12/2016"
output:
  pdf_document:
    keep_tex: yes
  html_document:
    keep_md: yes
bibliography: jsm2017.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      dev = "png",
                      dpi = 200)
```

```{r library-calls, echo = FALSE, include = FALSE}

# install ggplot2 version 2.1.0
# # devtools::install_version("ggplot2","2.1.0")
library(tidyverse)
library(ggmissing)
library(visdat)
```

```{r narnia-functions, include = FALSE}


# give NAs a more meaningful label
is_na <- function(x) {
  factor(is.na(x), levels = c(FALSE, TRUE), labels = c("!NA", "NA"))
}

# append some shadow cols

# return a tibble that is a shadow matrix form.

as_shadow <- function(data){

  data_shadow <- map_df(data, is_na)

  names(data_shadow) <- paste0(names(data),"_NA")

  data_shadow

  }

# as_shadow(airquality)

bind_shadow <- function(data){

  # data_shadow <- map_df(data, is_na)
  # names(data_shadow) <- paste0(names(data),"_NA")
  data_shadow <- as_shadow(data)

  bound_shadow <- as_tibble(dplyr::bind_cols(data, data_shadow))

  bound_shadow

}

gather_shadow <- function(data){
  
  as_shadow(data) %>%
  mutate(rows = 1:nrow(.)) %>%
  gather(key = "var",
         value = "miss",
         -rows) 
}

prop_na <- function(x){
  
  prop_na_df <- data_frame(
    df = percent_missing_df(x),
    var = percent_missing_var(x),
    case = percent_missing_case(x)
  )
  
  prop_na_df
  
}

# prop_na(airquality)
# tao1 <- tao %>% filter(year == 1997)
# tao2 <- tao %>% filter(year == 1993)
# # 
# ggmissing::summary_missing_var(tao)
# ggmissing::summary_missing_var(tao1)
# ggmissing::summary_missing_var(tao2)
# # 

# percent_missing_df()
# miss_prop_df(tao)
# prop_na_df(tao)
# mean(is.na(tao))


```

# Introduction

Missing data is ubiquitous in data analysis. Existing approaches to exploring missing data structure provide stand alone software, or build their own workflow inside R. ggplot2, an implementation of the grammar of graphics is an incredibly popular way to produce data visualisations does not currently support missing data. Tidy data format [@Wickham2014] states that each row is an observation and each column is a variable, which makes it easy and consistent to perform data manipulation and wrangling. There are currently no guidelines for representing additional missing data structures in a tidy format. This paper describes approaches for exploring missing data structure with minimal deviation from the common workflows of ggplot and tidy data structures. We first describe typical sources of missing data, seribe existing software for handling missing data, we then go on to explain data structures for missing data, visulisations and numerical summaries for missing data, and then discuss the impact of these methods, the current limitations, and future plans.

# Types of missing data

Canonical sources of missing data are questionnaires. Data obtained from questionnaires are often subject to both unknown and known missingness structure. Unknown missing data structure may arise from respondents accidentally failing to answer questions or inadvertently providing inappropriate answers. Known missing data structure data may arise due to the structure of the questionnaire. For example, the first question on a survey might be: 'If YES, skip to question 4', resulting in questions 2 and 3 missing. If the structure of the questionnaire is known, this type of missingness can be evaluated easily. However, if this information is not available, the mechanism responsible for producing missing data must be inferred from the data. Longitudinal studies are also sources of missing data, where participants may not return for future testing sessions. In these cases it is difficult, sometimes impossible, to ascertain the reason for the dropouts, and hence, whether the missingness structure is known or unknown.

There are a two main approaches to analysis of data with missing values, deletion and imputation. The first approach is deletion, where variables, or cases may be dropped depending on the amount of missing data. It is now widely regarded as best practice to instead impute these values, replacing the missing values with some other value estimated from the data [@Schafer2002]. In order for estimates to be unbiased, it is essential to understand the missingness structure and mechanisms [@Little1988; @Rubin1976; @simon-simonoff]. 

## Existing packages for handling missing data

Software focussing on missing data typically focus on imputation or visualisation. Packages such as mice, Hmisc, mi, Amelia, and mitools provide functions to facilitate imputation, and use a wide range of methods, from mean or median imputation, to regression or machine learning, to Bayesian methodologies [@mice; @Hmisc; etc. ]. Packages typically provide approaches for aggregating and evaluating imputations. Maintaining a consistent data structure when  These packages provide a wide variety of different imputation methods, with more work from new packages such as `simputation` [@simputation] using the pipe `%>%` operator with imputation procedures and working with the `dplyr` data manipulation. It is again important to take care  to avoid bias when performing multiple imputation.

Missing data visualisation packages include the R package VIM, and the stand alone softwares MANET, ggobi, and MissingDataGUI [@cheng2015; @Unwin1996; @swayne2003ggobi; @vim].  MANET (Missings Are Now Equally Treated), provides univariate visualisations of missing data using linked brushing between a reference plot of the missingness for each variable, and a plot of the data as a histogram or barplot. ggobi extends the univariate linked brushing of MANET to multivariate, using parallel co-ordinate plots. ggobi also provided incoporated missingness into scatterplots, displaying missing values from one variable as 10% below the minimum value on the other axis. MissingDataGUI provides a user interface for exploring missing data structure both numerically and visually.  A limitation of these softwares are that being stand alone software packages breaks workflow from statistical analysis. Although using a GUI to explore missing data may provide some valuable insights into important structures, it can then be hard to incorporate these unscripted insights into reproducible analyses.

VIM (Visualising and Imputing Missing Data) is an R package that provides methods for both imputation and visualisation of missing data. In particular it provides visualisations that identify observed, imputed, and missing values. VIM also identifies imputed cases by adding a suffix to a variable, so Var1 would have a sibling indicator column, Var1_imp, where each case is TRUE or FALSE to indicate imputed or not. Although VIM provides R functions to visualise and impute missing data, it's syntax for data manipulation and visualisation is difficult to extend, and as a result can be difficult to keep in a tidy framework. ggplot2, an implementation of Lee Wilkenson's grammer of graphics in R (very popular), currently only provides visualisation of missing values for categories when there is a category variable, this provides visualisations for missing data when the values being plotted are categories, it treats one of the categories as a NA value. For all other plots, ggplot2 prints a warning message notifying the user how many missing values have been ommited form the plot.

We see that there are many ways to explore missing data structure and imputation, however there is no unified methodology or approach to representing data structures, imputing values, and visualising missing data structure. We now discuss how we can represent missing data in particular data structures that align themselves with a tidy data workflow.

# Data structures for missing data

Representing missing data structure is achieed using the shadow matrix, introduced in Swayne and Buja @Swayne1998 [-@Swayne1998]. The shadow matrix is the same dimension as the data, and consists of binary indicators of "missingness" of data values. In our case, missing is represented as "NA", and not missing is represented as "!NA", although these may be represented as 1 and 0, respectively. This can be seen in figure 1 below. This structure can also be extended to allow for additional factor levels to be created, where 0 indicates presence, 1 indicates missing, 2 might indicate an imputed value, or 3 might indicate a particular type or class of missingness - perhaps missing due to a particular reason.

\begin{figure}[h]
\centering
\includegraphics[width=270pt]{/Users/tierneyn/Google Drive/ALL THE THINGS/PhD/code/R/jsm2017/diagram.png}
\end{figure}

<!-- ![Diagram of the representations of missing data structures, and subsequent visualisations](/Users/tierneyn/Google Drive/ALL THE THINGS/PhD/code/R/jsm2017/diagram.png) -->



The shadow matrix is represented in figure 1 going from Data to Shadow to show the existing datastructure, adding the suffix "_NA" to the variables. The data matrix can be augmented to include the shadow matrix, which facilitates visualisation of univariate and bivariate missing data visualisations. Another format is to display it in long form, which facilitates heatmap type visualisations of missing data.

## Visualising missing data

**Heatmap**

One common method for visualising missing data is to display a heatmap of the shadow matrix. This approach can be very helpful for giving an overview of which variables contain the most missingness. Methods can also be applied to rearrange rows and columns to find clusters, and identify other interesting features of the data that may have previously been hidden or unclear. This method is shown below using the `vis_miss` command from the `visdat` package.

```{r fig.height = 4, fig.width = 10, echo = FALSE}

library(visdat)
p1 <- vis_miss(airquality)
p2 <- vis_miss(airquality, cluster = TRUE)

gridExtra::grid.arrange(p1,p2,ncol = 2)

```

Similar approaches have been used in other missing data packages such as VIM, mi, Amelia, and MissingDataGUI. However this plot provides the additional benefits of being in the ggplot framework, which gives users greater control over the plot appearance, and alter and update the figure as they need. The user can also apply clustering of the rows and columns using the `cluster = TRUE` argument.

**Facetted plots**

An advantage of the wide shadow format is that it allows for referring to missingness of other variables along the values of another variable. For example, we an explore the values of when Solar.R is present and missing. The density plot shows both missing and not missing Solar.R in one plot, but the histogram shows that there really aren't many values of Ozone that are missing.

```
ggplot(data = bind_shadow(airquality),
       aes(x = Ozone)) + 
  geom_histogram() + 
  facet_wrap(~Solar.R_NA,
             ncol = 1)

ggplot(data = bind_shadow(airquality),
       aes(x = Ozone,
           colour = Solar.R_NA)) + 
  geom_density()
```



```{r bind-shadow-density, fig.height = 4, fig.width = 10, error = FALSE, message = FALSE, echo = FALSE, }

p1 <- ggplot(data = bind_shadow(airquality),
       aes(x = Ozone)) + 
  geom_histogram(na.rm = TRUE) + 
  facet_wrap(~Solar.R_NA,
             ncol = 1)

p2 <- ggplot(data = bind_shadow(airquality),
       aes(x = Ozone,
           colour = Solar.R_NA)) + 
  geom_density(na.rm = TRUE)

gridExtra::grid.arrange(p1,p2,ncol = 2)

```

Using this data structure facilitates missing data visualisation with ggplot as it means that the user can directly refer to the variable that they want to explore missingness. In the case above, the user is looking at a histogram of Ozone, but is then able to look at how many Ozone values are affected by Solar.R. In cases where there is no missing data in the variable that they want to "split" the missingness by, the plot simple returns a single facetted plot.

Another method of visualisation can be explored using `geom_missing_point()` from the `ggmissing` package:

```{r ggeom_missing, fig.height = 4, fig.width = 10}

ggplot(data = airquality,
       aes(x = Ozone,
           y = Solar.R)) + 
  geom_missing_point()
```

This replaces missing values to be 10% below the minimum value, a technique borrowed from ggobi. The missing values are also different colours to make missingness preattentive.

## Numerical Summaries for missing data

Numerical summaries of missing data are also made easy with some helper functions from the `ggmissing` package. For example, finding the overall proportion of missing values in the data overall, or the cases, or variables, can be done with `percent_missing_*` functions.


```{r numerical-percent-missing}

# Proportion elements in dataset that contains missing values
percent_missing_df(airquality)
# Proportion of variables that contain any missing values
percent_missing_var(airquality)
 # Proportion of cases that contain any missing values
percent_missing_case(airquality)

```

We can also look at the number and percent of missings in each case, and in each variable with `summary_missing_case`, and `summary_missing_var`.

```
summary_missing_case(airquality)
```

```{r echo = FALSE}
summary_missing_case(airquality) %>% slice(1:5)
```


```{r}

summary_missing_var(airquality)

```

We can also present tabulations that present more complicated inferences with `table_missing_case` and `table_missing_var`. These tally up the number of missings in each case or variable, then describe how many cases or variables have that many missings, and the percentage of cases or variables that contain missings


```{r}

ggmissing::table_missing_case(airquality)
ggmissing::table_missing_var(airquality)

```

<!-- it would be really cool if we could implement dplyr `group_by` syntax for the data, to produce summaries of missingness for 1993 and 1997 respectively. -->

# Discussion

We describe the current packages and software for exploring and visualising missing data.



This is the `bind_shadow` versus computing on the fly with `is_na`

```

ggplot(data = bind_shadow(airquality),
       aes(x = Ozone)) + 
  geom_histogram() + 
  facet_wrap(Solar.R_NA),
             ncol = 1)
             
ggplot(data = airquality,
       aes(x = Ozone)) + 
  geom_histogram() + 
  facet_wrap(is_na(Solar.R),
             ncol = 1)

```

It is important to consider then the implications for storage, when using bind_shadow, and computation, when using the `is_na` approach. `bind_shadow` provides some flexibility and extensibility, as it allows for more complex types of missingness. For example, it could extending from missing, `NA`,and not missing, `!NA`, to extend to different mechanisms for missingness `NA_missing_for_reason_A`, `NA_missing_for_reason_B`, or imputed values `value_imputed`. 

**Limitations**

More research is needed to be done on how to visualise, store, and summarise imputations while staying in a tidy data framework. Multiple imputation could be stored using nested dataframes for each multiple imputation. We didn't discuss how to visualise imputations, but you can imagine a similar framework for labelling imputations in a data structure.


**Future work**

explore model-based approaches for exploring  based missing data structures.

- How does this expand the field?
- How is this different to previous findings / usage?


# References

